# 7.14 Guardando el historial de cambios

Puedes agregar otro action filter para ir registrando todos los cambios que realizan los usuarios al sistema, vamos a registrar el usuario, la fecha en que se realiza el cambio, y un campo adicional para agregar opciones adicionales, como por ejemplo mostrar algún valor anterior. 

Agregamos nuestra clase **HistorialDAO** para registrar el historial de los usuarios. El método borrar va a borrar la información del historial del registro que se esta borrando.

{% code-tabs %}
{% code-tabs-item title="HistorialDAOcs" %}
```csharp
public class HistorialDAO
{
    private readonly CaducaContext contexto;
    private readonly LocService localizacion;

    public HistorialDAO(CaducaContext context, LocService locService)
    {
        this.contexto = context;
        this.localizacion = locService;
    }

    public async Task<bool> AgregarAsync(int usuarioId, 
                                            int actividad,
                                            string nombreTabla, 
                                            int origenId,
                                            string observaciones)
    {
        var tablaId = await ObtenerIdTablaAsync(nombreTabla);
        Historial historial = new Historial
        {
            Actividad = actividad,
            FechaHora = DateTime.Now,
            Observa = observaciones,
            OrigenId = origenId,
            TablaId = tablaId,
            UsuarioId = usuarioId
        };
        contexto.Historial.Add(historial);
        return true;
    }

    private async Task<int> ObtenerIdTablaAsync(string nombreTabla)
    {
        Tabla tabla = await contexto.Tabla
                .FirstOrDefaultAsync(e => e.Nombre == nombreTabla);
        if (tabla == null)
        {
            return -1;
        }
        return tabla.Id;
    }
    
    public async Task<bool> BorraAsync( string nombreTabla, 
                                         int origenId)
    {
        var tablaId = await ObtenerIdTablaAsync(nombreTabla);
        var consulta = await (from historial in contexto.Historial
                        where historial.TablaId == tablaId
                        && historial.OrigenId == origenId                 
                        select historial).ToListAsync();
        contexto.Historial.RemoveRange(consulta);
        contexto.SaveChanges();
        return true;
    }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

Agregamos una Enumeración **ActividadEnumeration** con los tipos de actividades que los usuarios pueden realizar.

{% code-tabs %}
{% code-tabs-item title="ActividadEnumeration.cs" %}
```csharp
public enum ActividadEnumeration
{
    Insertar    = 1,
    Modficar    = 2,
    Autorizar   = 3,
    Cancelar    = 4 
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

Para esto agregamos una propiedad llamada **Id** de tipo **entero** a nuestra clase **BaseController,** aqui vamos a agregar el Id de cada registro que se este actualizando

{% code-tabs %}
{% code-tabs-item title="BaseController.cs" %}
```csharp
public class BaseController : Controller
{
    public int Id;
    public string Observaciones;
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

En **ProductosController** a los métodos Post, Put y Delete vamos a agregar el Id del registro

{% code-tabs %}
{% code-tabs-item title="ProductosController.cs" %}
```csharp
public class ProductosController : BaseController
{
    [HttpPost]
    public async Task<IActionResult> PostProducto(
                                       [FromBody] Producto producto)
    {
        if (!await productoDAO.AgregarAsync(producto))
        {
            return StatusCode(productoDAO.customError.StatusCode,
                                  productoDAO.customError.Message);
        }
        Id = producto.Id;
        return CreatedAtAction("GetCategoria", 
                              new { id = producto.Id }, producto);
    }
    
    [HttpPut("{id}")]
    public async Task<IActionResult> PutProducto([FromRoute] int id, 
                                        [FromBody] Producto producto)
    {
        if (!ModelState.IsValid)
            return BadRequest(ModelState);

        if (id != producto.Id)
             return BadRequest();

        if (!await productoDAO.ModificarAsync(producto))
        {
            return StatusCode(productoDAO.customError.StatusCode,
                                  productoDAO.customError.Message);
        }
        Id = producto.Id;
        return NoContent();
    }
    
    [HttpDelete("{id}")]
    public async Task<IActionResult> DeleteProducto([FromRoute] int id)
    {
        if (!ModelState.IsValid)
            return BadRequest(ModelState);
        if (!await productoDAO.BorraAsync(id))
        {
                return StatusCode(productoDAO.customError.StatusCode,
                                  productoDAO.customError.Message);
        }
        Id = id;
        return Ok();
    }
```
{% endcode-tabs-item %}
{% endcode-tabs %}

En nuestra carpeta Filters agregamos un nueva clase **HistorialFilter**

{% code-tabs %}
{% code-tabs-item title="HistorialFilter.cs" %}
```csharp

```
{% endcode-tabs-item %}
{% endcode-tabs %}

