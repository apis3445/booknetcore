# 7.8.2 ¿Cómo obtener la ciudad del usuario por medio de la IP?

Otra recomendación que se suele hacer es registrar las ciudades y dispositivos de donde se conecta el usuario normalmente y enviar un correo cuando se conecta de otra ciudad diferente.

Existen bases de datos gratuitas y de pago donde por medio de la ip te regresan la ciudad aproximada de donde se conectó el usuario. 

Si deseas bajar tu base de datos aqui tienes una gratuita. Esta base de datos se actualiza constantemente.

{% embed url="https://lite.ip2location.com/?r=piwik" %}

Existen servicios rest en donde tu envias la ip y te regresan los datos de la ip, algunos ofrecen servicios gratuitos limitados a por ejemplo 1,000 peticiones por día o varía el precio de acuerdo al número de peticiones.

Algunos de los servicios gratuitos son los siguientes, los cuales te permiten 1,000 peticiones por día.

{% embed url="https://ipgeolocation.io/pricing.html" %}

{% embed url="https://www.iplocate.io/pricing" %}

En mi ejemplo utilizare iplocate

{% hint style="info" %}
Si deseas puedes guardar cada día las ip de los usuarios para consultar de tu base de datos en lugar del servicio, si varios usuarios se conectan del mismo lugar.
{% endhint %}

Para mandar llamar el servicio puedes conectarte por postman o desde el navegador utilizando la siguiente petición

[https://www.iplocate.io/api/lookup/35.232.52.59](https://www.iplocate.io/api/lookup/35.232.52.59)

Te regresa un json similar a este

```javascript
{
  "ip"          : "35.232.52.59",
  "country"     : "United States",
  "country_code": "US",
  "city"        : "Mountain View",
  "continent"   : "North America",
  "latitude"    : 37.4043,
  "longitude"   : -122.0748,
  "time_zone"   : "America/Los_Angeles",
  "postal_code" : "94043",
  "org"         : "Google LLC",
  "asn"         : "AS15169",
  "subdivision" : "California",
  "subdivision2": null
}
```

Puedes entrar a la siguiente página donde le copias el json regresado por algún servicio y te genera una clase en c\# o puedes copiar el json a visual studio utilizando la opción Pegado Especial -&gt; Pegar Json como Clase

{% embed url="https://www.jsonutils.com" %}

Agregamos la clase generada en nuestra carpeta **DTO**

{% code-tabs %}
{% code-tabs-item title="DatosIPDTO.cs" %}
```csharp
public class DatosIPDTO
{
        public string ip { get; set; }
        public string country { get; set; }
        public string country_code { get; set; }
        public string city { get; set; }
        public string continent { get; set; }
        public double latitude { get; set; }
        public double longitude { get; set; }
        public string time_zone { get; set; }
        public string postal_code { get; set; }
        public string org { get; set; }
        public string asn { get; set; }
        public string subdivision { get; set; }
        public object subdivision2 { get; set; }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

Agrega un nuevo archivo **NuevoAcceso.html** en nuestra carpeta **Templates** el cual contiene el siguiente formato:

{% code-tabs %}
{% code-tabs-item title="NuevoAcceso.html" %}
```markup
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <style>
            body
            {
                font-size: 1.3rem;
                color: #05678e;
            }
            .acceso
            {
                border-radius: 10px;
                border: solid 1px #ccc;
                padding: 20px;
            }
            label
            {
                display: inline-block;
                width: 130px;
                font-weight:bold;
            }
            .titulo
            {                
                font-size: 1.5rem;
                font-weight:bold;
            }
    </style>
</head>
<body>   
    <p>
        ¡Hola {{usuario}}!
        <h3>Alguien accedió a tu cuenta en una nueva ciudad</h3>
    </p>
    <div class="acceso">
        <span class="titulo">Nuevo acceso en: 
                                    {{sistemaOperativo}}</span>
        <br />
        <label>Navegador:</label>{{navegador}}
        <br />
        <label>El:</label>{{fecha}}
        <br />
        <label>Cerca de:</label>{{ciudad}}, {{estado}}, {{pais}}
        <br />
        <label> Ip:</label>{{ip}}
        <hr />
        <p>
            Te enviamos este correo electrónico para asegurarnos de 
            que hayas sido tú.
            Si no fuiste tú, por favor comunícate con nosotros.           
        </p>
    </div>
</body>
</html>
```
{% endcode-tabs-item %}
{% endcode-tabs %}

 En nuestro archivo UsuariosController necesitamos un objeto de la interfaz 

```text
IHttpContextAccessor
```

Como en el modo de desarrollo desde visual studio el código para obtener la ip no funciona agregamos una ip por default.

{% code-tabs %}
{% code-tabs-item title="UsuariosController.cs" %}
```csharp
public class UsuariosController : BaseController
{
    private IHttpContextAccessor _accessor;
    
    public UsuariosController(CaducaContext context,
                              LocService localize,
                              IConfiguration config,
                              IHostingEnvironment hostingEnvironment,
                              IHttpContextAccessor accessor)
                               : base(context, localize)
    {           
        //Códgio
        _accessor = accessor;
    }
    
    [HttpPost("Login")]
    [AllowAnonymous]
    public async Task<IActionResult> PostAsync([FromBody] 
                                            LoginDTO loginDTO)
    {
        string ip = "189.145.141.65"; //Set default ip
        if (_hostingEnvironment.IsProduction())        
             ip =_accessor.HttpContext?.Connection?
                                     .RemoteIpAddress?.ToString();
    }
 }
```
{% endcode-tabs-item %}
{% endcode-tabs %}

Agregamos una clase **IPLocate** la cual llamará al servicio rest de IPLocate para a través de la IP nos regrese la ciduad. 

{% code-tabs %}
{% code-tabs-item title="IPLocate" %}
```csharp
public class IPLocate
{
    /// <summary>
    /// LLamamos al servicio IPLocate para obtener los datos de una ip
    /// </summary>
    /// <param name="ip">Ip del cliente</param>
    /// <returns></returns>
    public async Task<DatosIPDTO> ObtenerDatosPorIpAsync(string ip)
    {
        HttpClient client = new HttpClient();
        DatosIPDTO datosIP;
            
        var respuesta = await 
                client.GetStringAsync
                    ("https://www.iplocate.io/api/lookup/" + ip);
        datosIP = JsonConvert.DeserializeObject<DatosIPDTO>(respuesta);           
        return datosIP;
    }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

{% hint style="info" %}
Como una mejora, se puede crear una interfaz IIPServicio con el método ObtenesDatosPorIpAsync para si a futuro se desea cambiar el método para obtener las IP lo deseamos cambiar a alguna de paga o de otra compañia. 
{% endhint %}

Agregamos nuestra clase **UsuarioAccesoDAO** para agregar el nuevo registro, la cual va a recibir el objeto TokenDTO con los datos del Token, el id del usuario, y la ip para registrar el acceso.

{% code-tabs %}
{% code-tabs-item title="UsuarioAccesoDAO" %}
```csharp
public class UsuarioAccesoDAO
{
    private readonly CaducaContext contexto;
    private readonly LocService localizacion;

    public UsuarioAccesoDAO(CaducaContext context,
                            LocService locService)
    {
        this.contexto = context;
        this.localizacion = locService;
    }

    public async System.Threading.Tasks.Task<bool>
             GuardarAccesoAsync(TokenDTO tokenDTO, 
                                int usuarioId, 
                                string ip)
    {
        var usuarioAcceso = new UsuarioAcceso();

        var ipLocate = new IPLocate();
        var datosIP = await ipLocate.ObtenerDatosPorIpAsync(ip);
        if (datosIP != null)
        {
            usuarioAcceso.Ciudad = datosIP.city;
            usuarioAcceso.Estado = datosIP.subdivision;
        }
        usuarioAcceso.UsuarioId = usuarioId;
        usuarioAcceso.Fecha = DateTime.Now;
        usuarioAcceso.Token = tokenDTO.Token;
        usuarioAcceso.Activo = true;
        usuarioAcceso.SistemaOperativo = "Default";
        usuarioAcceso.RefreshToken = tokenDTO.RefreshToken;
        usuarioAcceso.Navegador = "Default";
        contexto.UsuarioAcceso.Add(usuarioAcceso);
        contexto.SaveChanges();
        return true;
    }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

En nuestro método LoginAsync agregamos el parámetro de la ip y la nueva clase.

{% code-tabs %}
{% code-tabs-item title="UsuarioDAO.cs" %}
```csharp
public async Task<TokenDTO> LoginAsync(LoginDTO loginDTO, 
                                       IConfiguration config, 
                                       string ip)
{
    var usuario = await ObtenerPorClave(loginDTO.Usuario);
    if (usuario == null)
        return tokenDTO;
    if (!EsUsuarioActivo(usuario))
        return tokenDTO;
    if (!EsPasswordValido(usuario, loginDTO.Password, loginDTO.Codigo))
            return tokenDTO;
    tokenDTO = GenerarToken(config, usuario.Id, usuario.Nombre);
    UsuarioAccesoDAO usuarioAccesoDAO =
                 new UsuarioAccesoDAO(contexto, localizacion);
    await usuarioAccesoDAO.GuardarAccesoAsync(tokenDTO, usuario.Id, ip);
    return tokenDTO;
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

{% hint style="info" %}
Otra mejora puede ser registrar las ips y su ciudad para no hacer tantas peticiones al servicio y ahorras costos.
{% endhint %}

