# 7.10 Seguridad con reglas personalizadas

Si deseas otro nivel de seguridad mas personalizado aparte de que sea por roles, necesitas por ejemplo:

1. Solamente los vendedores que tengan categorías de productos asignadas.
2. Si tienes vendedores con permisos de solo lectura y vendedores con permisos de lectura y escritura
3. Que tus servicios los vean solo personas mayores de edad

Puedes agregar claims a tu token y en cada servicio validar que según el claim se cumpla con la condición. 

### 7.10.1 Seguridad basada en claims

Para el caso 1, en el login puedes agregar un claim con la clave Categorias y el valor que cuente el número total de categorías.  Solamente los usuarios con el rol vendedor que tengan categorías asignadas son los que tendrían este rol.

En tus servcios para validar que solo los empleados con categorías pueden acceder al servicio.

En nuestro archivo **Startup**  en el método **ConfigureServices** agregamos una nueva política, le damos un nombre y como política \(**policy**\) indicamos que el servicio necesitará tener registrado un claim llamado Categorías \(**RequireClaim**\)

{% code-tabs %}
{% code-tabs-item title="Startup.cs" %}
```csharp
public class Startup
{
   public void ConfigureServices(IServiceCollection services)
   {
       services.AddAuthorization(options =>
      {
           options.AddPolicy("VendedorConCategorias", 
                            policy => policy.RequireClaim("Categorías"));
      }); 
   }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

En nuestra carpeta M**odels** agregamos nuestro Archivo **UsuarioCategoria**

{% code-tabs %}
{% code-tabs-item title="UsuarioCategoria.cs" %}
```csharp
public class UsuarioCategoria
{
    [Key]
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int Id { get; set; }

    [Required(ErrorMessage = "Required")]
    public int UsuarioId { get; set; }

    [Required(ErrorMessage = "Required")]
    public int CategoriaId { get; set; }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

Agregamos las llaves fóraneas e índices en nuestra carpeta **EntityConfigurations**

{% code-tabs %}
{% code-tabs-item title="UsuarioCategoriaConfiguration.cs" %}
```csharp
public class UsuarioCategoriaConfiguration
                             : IEntityTypeConfiguration<UsuarioCategoria>
{
    public void Configure(EntityTypeBuilder<UsuarioCategoria> builder)
    {
        builder.HasIndex(u => new { u.UsuarioId, u.CategoriaId })
            .HasName("UI_UsuarioCategoria")
            .IsUnique();

        builder.HasOne(typeof(Usuario))
                .WithMany()
                .OnDelete(DeleteBehavior.Restrict);

        builder.HasOne(typeof(Categoria))
                .WithMany()
                .OnDelete(DeleteBehavior.Restrict);
    }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

Agregamos el modelo y las llaves foráneas a nuestra archivo **Startup.cs**

{% code-tabs %}
{% code-tabs-item title="Startup.cs" %}
```csharp
public class CaducaContext : DbContext
{
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        //... Código
        modelBuilder.ApplyConfiguration
                                 (new UsuarioCategoriaConfiguration());
         //... Código
         public virtual DbSet<UsuarioCategoria> 
                                  UsuarioCategoria { get; set; }
    }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}



