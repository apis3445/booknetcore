# 7.12 Seguridad basada en directivas

Puedes utilizar la clase de .NET [OperationAuthorizationRequirement](https://docs.microsoft.com/es-es/dotnet/api/microsoft.aspnetcore.authorization.infrastructure.operationauthorizationrequirement)  la cual nos facilita registrar todos los posibles permiso que maneja tu aplicación. Creamos una clase **Operaciones** en nuestra carpeta **Core** y agregamos los tipos de permisos que manejará nuestra aplicación.

{% code-tabs %}
{% code-tabs-item title="Operaciones.cs" %}
```csharp
public static class Operaciones
{
    public static OperationAuthorizationRequirement Crear = new
            OperationAuthorizationRequirement
    { Name = "Crear" };
    public static OperationAuthorizationRequirement Modificar = new
            OperationAuthorizationRequirement
    { Name = "Modificar" };
    public static OperationAuthorizationRequirement Borrar = new
            OperationAuthorizationRequirement
    { Name = "Borrar" };
    public static OperationAuthorizationRequirement Consultar = new
            OperationAuthorizationRequirement
    { Name = "Consultar" };
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

Creamos una clase PermisoDTO el cual nos indica que tabla deseamos validar, y también indicamos una variable SoloAdministradores en el cual si esta en true esta tabla sólo es accesible a los usuarios con el rol de Administrador.

{% code-tabs %}
{% code-tabs-item title="PermisoDTO.cs" %}
```csharp
namespace CaducaRest.DTO
{
    /// <summary>
    /// Permite validar los permisos de cada servicio
    /// </summary>
    public class PermisoDTO
    {
        /// <summary>
        /// Nombre de la tabla a validar
        /// </summary>
        public string Tabla { get; set; }

        /// <summary>
        /// Si esta en true se requiere permiso de Administrador
        /// </summary>
        public bool EsAdministrador { get; set; } = false;
    }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

Creamos nuestra clase **RolTablaPermisoDAO** la cual nos va a ayudar a validar que el usuario tenga acceso a la tabla de acuerdo a su rol, para la operación a realizar

{% code-tabs %}
{% code-tabs-item title="RolTablaPermisoDAO.cs" %}
```csharp
using System.Linq;
using CaducaRest.Models;
using CaducaRest.Resources;

namespace CaducaRest.DAO
{
    public class TablaRolPermisoDAO
    {
        private readonly CaducaContext contexto;
        private readonly LocService localizacion;

        public TablaRolPermisoDAO(CaducaContext context, LocService localize)
        {
            this.contexto = context;
            this.localizacion = localize;
        }

        public bool TienePermiso(int usuarioId, string tabla,
                                 string operacion)
        {
           var test= from Tabla in contexto.Tabla select Tabla.Nombre;
            var permiso = (from Tabla in contexto.Tabla
                           join TablaPermiso in contexto.TablaPermiso
                            on Tabla.Id equals TablaPermiso.TablaId
                           join Permiso in contexto.Permiso
                            on TablaPermiso.PermisoId equals Permiso.Id
                            join RolTablaPermiso in 
                                            contexto.RolTablaPermiso
                                on TablaPermiso.Id equals 
                                           RolTablaPermiso.TablaPermisoId
                            join UsuarioRol in contexto.UsuarioRol
                                on RolTablaPermiso.RolId equals 
                                           UsuarioRol.RolId
                           where Tabla.Nombre == tabla
                            && Permiso.Nombre == operacion
                            && UsuarioRol.UsuarioId == usuarioId
                            && RolTablaPermiso.TienePermiso
                           select RolTablaPermiso.Id).FirstOrDefault();                     
            return permiso>0;
        }
    }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

Para nuestras reglas personalizadas es necesario crear una clase que herede de **AuthorizationHandler,** la cual recibe como objetos genéricos un objeto de la clase **OperationAuthorizationRequirement** y cualquier otro dato adicional en nuestro caso es nuestra clase **PermisoDTO.** Agregamos una clase llamada **PermisoEditHandler** en nuestra carpeta Core

{% code-tabs %}
{% code-tabs-item title="PermisoEditHandler.cs" %}
```csharp

```
{% endcode-tabs-item %}
{% endcode-tabs %}

\*\*\*\*

