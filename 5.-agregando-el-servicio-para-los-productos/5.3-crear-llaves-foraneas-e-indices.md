# 5.3 Crear llaves fóraneas e índices

Vamos a crear una llave foránea en nuestra tabla producto para la tabla categoria y nuestro índice. 

{% hint style="info" %}
Se recomienda crear un índice por cada campo que es llave foránea 
{% endhint %}

Dentro de nuestra carpeta **Models** -&gt; **Entity Configurations** agregamos una nueva clase **ProductoConfiguration.cs**

Heredamos de la clase **IEntityTypeConfiguration** e implementamos el constructos de esta clase

### Creación de Índice

Creamos un índice para el campo CategoríaId, para los índices que no son únicos, empezaran con la palabra **IX** seguido de la tabla en nuestro caso producto, seguido de la tabla con la cual tiene la llave foránea, categoria

{% code-tabs %}
{% code-tabs-item title="ProductoConfiguration.cs" %}
```csharp
public class ProductoConfiguration : IEntityTypeConfiguration<Producto>
{
    public void Configure(EntityTypeBuilder<Producto> builder)
    {
         builder.HasIndex(e => e.CategoriaId)
             .HasName("IX_ProductoCategoria")
             .IsUnique();
    }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

### Creación de llave foránea

Para las llaves foráneas se utiliza la opción **HasOne** donde pasamos como parámetro el tipo de nuestra tabla, en esta caso Categori,a luego elegimos **WithMany** para indicar que una categoría puede tener muchos productos, por último elegimos la opción para el borrar, las cuales son las siguientes:

* **DeleteBehavior.Restrict**: No se puede borrar una categoría si hay productos que tienen esa categoría. 
* **DeleteBehavior.Cascade:** Al borrar una categoria se borraran automáticamente todos los productos de esa categoría.

Para nuestro caso elegimos **Restrict** para no permitir borrar una categoría con productos.

{% code-tabs %}
{% code-tabs-item title="ProductoConfiguration.cs" %}
```csharp
public class ProductoConfiguration : IEntityTypeConfiguration<Producto>
{
    public void Configure(EntityTypeBuilder<Producto> builder)
    {
         builder.HasIndex(e => e.CategoriaId)
             .HasName("IX_ProductoCategoria")
             .IsUnique();

         builder.HasOne(typeof(Categoria))
                   .WithMany()
                   .OnDelete(DeleteBehavior.Restrict);
     }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

Si deseas que todas tus tablas tengan la regla Restrict, puedes agregar el siguiente código a tu clase DBContext.

{% code-tabs %}
{% code-tabs-item title="CaducaContext.cs" %}
```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
     foreach (var relationship in modelBuilder.Model.GetEntityTypes()
                    .SelectMany(e => e.GetForeignKeys()))
     {
          relationship.DeleteBehavior = DeleteBehavior.Restrict;
     }
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

Recorremos todas las llaves foráneas de nuestro modelo y especificamos que la regla para borrar será restringir.

Agregamos la configuración de nuestra tabla Producto a la clase CaducaContext

{% code-tabs %}
{% code-tabs-item title="CaducaContext.cs" %}
```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder.ApplyConfiguration(new CategoriaConfiguration());
    modelBuilder.ApplyConfiguration(new ProductoConfiguration());
}
```
{% endcode-tabs-item %}
{% endcode-tabs %}

Agregamos nuestra migración en la Consola del Administrador de Paquetes

```text
Add-Migration LLaveProductosCategoria
```

En nuestro archivo de migración cambiamos el nombre de nuestra llave foránea para que siga el mismo nombrado que el indice

```text
 migrationBuilder.AddForeignKey(
                name: "FK_Producto_Categoria",
                table: "Producto",
                column: "CategoriaId",
                principalTable: "Categoria",
                principalColumn: "Id",
                onDelete: ReferentialAction.Restrict);
```

Actualizmaos nuestra base de datos agregando 

```text
Update-Database
```

